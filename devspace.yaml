version: v1beta9

images:
  graph:
    image: registry.digitalocean.com/pokernook/graph
    tags:
      - sha-${DEVSPACE_GIT_COMMIT}-${DEVSPACE_RANDOM}
    cmd: ["npm", "run", "dev"]
    preferSyncOverRebuild: true
    build:
      docker:
        useBuildKit: true
        options:
          target: develop

deployments:
  - name: postgres
    helm:
      componentChart: true
      values:
        containers:
          - image: postgres:12-alpine
            env:
              - name: POSTGRES_PASSWORD
                value: password
        service:
          ports:
            - port: 5432
  - name: redis
    helm:
      componentChart: true
      values:
        containers:
          - image: bitnami/redis:6.0
            env:
              - name: ALLOW_EMPTY_PASSWORD
                value: "yes"
        service:
          ports:
            - port: 6379
  - name: pokernook-graph
    helm:
      componentChart: true
      values:
        containers:
          - image: registry.digitalocean.com/pokernook/graph
            env:
              - name: APP_SECRET
                value: $!{APP_SECRET}
              - name: DATABASE_URL
                value: postgresql://postgres:password@postgres:5432
              - name: REDIS_URL
                value: redis://:@redis:6379
              - name: NODE_ENV
                value: development
              - name: PORT
                value: "4000"
        service:
          ports:
            - port: 4000

profiles:
  - name: production
    patches:
      - op: remove
        path: images.graph.cmd
      - op: remove
        path: images.graph.build.docker.options.target
      - op: remove
        path: deployments.name=postgres
      - op: remove
        path: deployments.name=redis
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=NODE_ENV.value
        value: production
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=DATABASE_URL.value
        value: $!{DATABASE_URL}
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=REDIS_URL.value
        value: $!{REDIS_URL}

dev:
  ports:
    - imageName: graph
      forward:
        - port: 4000
    - labelSelector:
        app.kubernetes.io/name: devspace-app
        app.kubernetes.io/component: postgres
      forward:
        - port: 5432
    - labelSelector:
        app.kubernetes.io/name: devspace-app
        app.kubernetes.io/component: redis
      forward:
        - port: 6379
  sync:
    - imageName: graph
      excludePaths:
        - .git/
      uploadExcludePaths:
        - node_modules
        - "**/*.graphql"
        - logs
        - "**/*.log"
        - npm-debug.log*
        - yarn-debug.log*
        - yarn-error.log*
        - lerna-debug.log*
        - /coverage
        - devspace.yaml
