version: v1beta9

images:
  graph:
    image: registry.digitalocean.com/pokernook/graph
    tags:
      - ${DEVSPACE_GIT_COMMIT}-${DEVSPACE_RANDOM}
    cmd: ["npm", "run", "dev"]
    preferSyncOverRebuild: true
    build:
      docker:
        skipPush: true # TODO: Push should be enabled for prod deploys
        useBuildKit: true
        options:
          target: develop

deployments:
  - name: postgres # TODO: This deployment should be dev only
    helm:
      componentChart: true
      values:
        containers:
          - image: postgres:12-alpine
            env:
              - name: POSTGRES_PASSWORD
                value: password
        service:
          ports:
            - port: 5432
  - name: server
    helm:
      componentChart: true
      values:
        containers:
          - image: registry.digitalocean.com/pokernook/graph
            env: # TODO: These should be pulled from external configuration
              - name: APP_SECRET
                value: appSecret
              - name: DATABASE_URL
                value: postgresql://postgres:password@postgres:5432
        service:
          ports:
            - port: 4000

dev:
  ports:
    - imageName: graph
      forward:
        - port: 4000
  sync:
    - imageName: graph
      excludePaths:
        - .git/
      uploadExcludePaths:
        - node_modules
        - generated
        - "**/*.graphql"
        - logs
        - "**/*.log"
        - npm-debug.log*
        - yarn-debug.log*
        - yarn-error.log*
        - lerna-debug.log*
        - /coverage
        - devspace.yaml
