version: v1beta9

images:
  graph:
    image: registry.digitalocean.com/pokernook/graph
    tags:
      - sha-${DEVSPACE_GIT_COMMIT}-${DEVSPACE_RANDOM}
    cmd: ["npm", "run", "dev"]
    preferSyncOverRebuild: true
    build:
      docker:
        useBuildKit: true
        options:
          target: develop

deployments:
  - name: database
    helm:
      chart:
        name: postgresql
        repo: https://charts.bitnami.com/bitnami
      values:
        image.repository: postgres
        image.tag: 12-alpine
        postgresqlPassword: password
  - name: cache
    helm:
      chart:
        name: redis
        repo: https://charts.bitnami.com/bitnami
      values:
        image.tag: "6.0"
        usePassword: false
  - name: pokernook-graph
    helm:
      componentChart: true
      values:
        containers:
          - image: registry.digitalocean.com/pokernook/graph
            env:
              - name: APP_SECRET
                value: $!{APP_SECRET}
              - name: DATABASE_URL
                value: postgresql://postgres:password@database-postgresql:5432
              - name: REDIS_URL
                value: redis://:@cache-redis-master:6379
              - name: NODE_ENV
                value: development
              - name: PORT
                value: "4000"
        service:
          ports:
            - port: 4000

profiles:
  - name: production
    patches:
      - op: remove
        path: images.graph.cmd
      - op: remove
        path: images.graph.build.docker.options.target
      - op: remove
        path: deployments.name=database
      - op: remove
        path: deployments.name=cache
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=NODE_ENV.value
        value: production
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=DATABASE_URL.value
        value: $!{DATABASE_URL}
      - op: replace
        path: deployments.name=pokernook-graph.helm.values.containers[0].env.name=REDIS_URL.value
        value: $!{REDIS_URL}

dev:
  ports:
    - imageName: graph
      forward:
        - port: 4000
    - labelSelector:
        app.kubernetes.io/instance: database
        app.kubernetes.io/name: postgresql
      forward:
        - port: 5432
    - labelSelector:
        app: redis
        role: master
      forward:
        - port: 6379
  sync:
    - imageName: graph
      excludePaths:
        - .git/
      uploadExcludePaths:
        - node_modules
        - "**/*.graphql"
        - logs
        - "**/*.log"
        - npm-debug.log*
        - yarn-debug.log*
        - yarn-error.log*
        - lerna-debug.log*
        - /coverage
        - devspace.yaml
