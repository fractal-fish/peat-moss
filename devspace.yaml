version: v1beta9

images:
  graph:
    image: pokernook/graph
    tags:
      - sha-${DEVSPACE_GIT_COMMIT}-${DEVSPACE_RANDOM}
    cmd: ["npm", "run", "dev"]
    preferSyncOverRebuild: true
    build:
      docker:
        useBuildKit: true
        options:
          target: develop

deployments:
  - name: postgresql
    helm:
      chart:
        name: postgresql
        repo: https://charts.bitnami.com/bitnami
      wait: true
      values:
        image.repository: postgres
        image.tag: 12-alpine
        postgresqlPassword: password
  - name: redis
    helm:
      chart:
        name: redis
        repo: https://charts.bitnami.com/bitnami
      wait: true
      values:
        image.tag: "6.0"
        usePassword: false
  - name: pokernook-graph
    helm:
      componentChart: true
      values:
        containers:
          - image: pokernook/graph
            env:
              - name: APP_SECRET
                value: $!{APP_SECRET}
              - name: DATABASE_URL
                value: postgresql://postgres:password@postgresql:5432
              - name: REDIS_URL
                value: redis://:@redis-master:6379
              - name: NODE_ENV
                value: development
              - name: PORT
                value: "4000"
        service:
          ports:
            - port: 80
              containerPort: 4000

dev:
  ports:
    - imageName: graph
      forward:
        - port: 4000
    - labelSelector:
        app.kubernetes.io/instance: postgresql
        app.kubernetes.io/name: postgresql
      forward:
        - port: 5432
    - labelSelector:
        app: redis
        role: master
      forward:
        - port: 6379
  sync:
    - imageName: graph
      excludePaths:
        - .git/
      uploadExcludePaths:
        - node_modules
        - "**/*.graphql"
        - logs
        - "**/*.log"
        - npm-debug.log*
        - yarn-debug.log*
        - yarn-error.log*
        - lerna-debug.log*
        - /coverage
        - devspace.yaml
